<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="p-4">
    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-lg mb-8">
        <div class="flex-1">
            <a href="#" class="btn btn-ghost normal-case text-xl">NotifyHub</a>
        </div>
        <div class="flex-none">
            <button class="btn btn-ghost">Logout</button>
        </div>
        <div class="flex-none gap-4">
            <!-- Notification Icon with Dropdown -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle">
                    <div class="indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <!-- Badge for Unverified Notifications -->
                        <span id="notification-badge" class="badge badge-xs badge-primary indicator-item">0</span>
                    </div>
                </label>
                <!-- Dropdown Content -->
                <div tabindex="0" class="mt-3 z-[1] card card-compact dropdown-content w-96 bg-base-100 shadow">
                    <div class="card-body">
                        <span class="font-bold text-lg">Notifications</span>
                        <!-- List of Notifications -->
                        <div id="notification-dropdown-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Notifications will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content (same as before) -->
    <div class="max-w-4xl mx-auto">
        <div class="card bg-base-100 shadow-md mb-6">
            <div class="card-body">
                <h2 class="card-title">Create New Notification</h2>
                <div class="join w-full">
                    <input type="text" id="create-user-id-input" placeholder="Enter User ID"
                        class="input input-bordered join-item w-full">
                    <button onclick="createNotification()" class="btn btn-primary join-item">Create</button>
                </div>
            </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
            <div class="card bg-base-100 shadow-md">
                <div class="card-body">
                    <h3 class="card-title">Unverified Notifications</h3>
                    <div id="unverified-notifications" class="space-y-2"></div>
                </div>
            </div>
            <div class="card bg-base-100 shadow-md">
                <div class="card-body">
                    <h3 class="card-title">Verified Notifications</h3>
                    <div id="verified-notifications" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ws = new WebSocket("ws://localhost:8080/ws");
        const displayedNotifications = new Map(); // Untuk melacak notifikasi yang sudah ditampilkan

        // WebSocket message handler yang diperbarui
        ws.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);
                if (data.payload) {
                    const notification = JSON.parse(data.payload);

                    // Jika notifikasi baru, tambahkan ke UI
                    if (!displayedNotifications.has(notification.id)) {
                        displayedNotifications.set(notification.id, notification);
                        addNotificationToUI(notification, data.channel.includes("verified"));
                        updateNotificationDropdown();
                    }
                    // Jika notifikasi diverifikasi, pindahkan ke verified
                    else if (data.channel.includes("verified")) {
                        moveNotificationToVerified(notification.id);
                        updateNotificationDropdown();
                    }
                }
            } catch (error) {
                console.error("WebSocket message error:", error);
            }
        };

        // Fungsi untuk menambahkan notifikasi ke UI
        function addNotificationToUI(notification, isVerified) {
            const container = document.getElementById(isVerified ? "verified-notifications" : "unverified-notifications");

            const div = document.createElement("div");
            div.id = `notif-${notification.id}`;
            div.classList.add("alert", isVerified ? "alert-success" : "alert-error");

            // Tambahkan label "New" atau "Old"
            const label = isVerified ? "Old Notification" : "New Notification";
            div.innerHTML = `
            <strong>${label}</strong>
            <div>${notification.message}</div>
            <small>${new Date(notification.timestamp).toLocaleString()}</small>
        `;

            // Tambahkan tombol verifikasi hanya untuk notifikasi unverified
            if (!isVerified) {
                const button = document.createElement("button");
                button.textContent = "Verify";
                button.classList.add("btn", "btn-sm", "btn-primary", "mt-2"); // Tambahkan margin-top
                button.onclick = () => verifyNotification(notification.id);
                div.appendChild(button);
            }

            container.prepend(div); // Tambahkan di bagian atas
            updateNotificationBadge();
        }




        // Fungsi untuk memindahkan notifikasi ke verified
        function moveNotificationToVerified(id) {
            const element = document.getElementById(`notif-${id}`);
            if (element) {
                // Hapus tombol verify
                const button = element.querySelector('button');
                if (button) button.remove();

                // Update styling dan konten
                element.classList.remove('alert-error');
                element.classList.add('alert-success');
                element.innerHTML = `
                <strong>Old Notification</strong>
                <div>${element.querySelector('div').textContent}</div>
                <small>${element.querySelector('small').textContent}</small>
            `;

                // Pindahkan ke container verified
                document.getElementById('verified-notifications').prepend(element);
                updateNotificationBadge();
            }
        }

        // Fungsi untuk memperbarui dropdown notifikasi
        function updateNotificationDropdown() {
            const dropdownList = document.getElementById("notification-dropdown-list");
            dropdownList.innerHTML = ""; // Kosongkan dropdown

            displayedNotifications.forEach(notification => {
                const div = document.createElement("div");
                div.classList.add("alert", notification.verified ? "alert-success" : "alert-error");

                // Tambahkan label "New" atau "Old"
                const label = notification.verified ? "Old Notification" : "New Notification";
                div.innerHTML = `
                <strong>${label}</strong>
                <div>${notification.message}</div>
                <small>${new Date(notification.timestamp).toLocaleString()}</small>
            `;
                dropdownList.appendChild(div);
            });
        }

        // Fungsi untuk memperbarui badge notifikasi
        function updateNotificationBadge() {
            const unverifiedCount = document.querySelectorAll('#unverified-notifications .alert').length;
            document.getElementById("notification-badge").textContent = unverifiedCount;
        }

        // Fungsi createNotification yang diperbarui
        async function createNotification() {
            const userID = document.getElementById("create-user-id-input").value;
            if (!userID) return alert("Please enter a User ID");
            try {
                const res = await fetch("http://localhost:8080/notifications", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "New Notification", user_id: userID })
                });
                if (!res.ok) throw new Error("Failed to create notification");

                // Kosongkan input setelah berhasil
                document.getElementById("create-user-id-input").value = "";
            } catch (error) {
                console.error("Create notification error:", error);
            }
        }

        // Fungsi verifikasi yang diperbarui
        async function verifyNotification(id) {
            try {
                const res = await fetch(`http://localhost:8080/notifications/verify/${id}`, { method: "PUT" });
                if (!res.ok) throw new Error("Failed to verify notification");

                // Pindahkan notifikasi secara lokal
                moveNotificationToVerified(id);
                updateNotificationDropdown();
            } catch (error) {
                console.error("Verification error:", error);
            }
        }

        async function fetchNotifications() {
            try {
                const [unverifiedRes, verifiedRes] = await Promise.all([
                    fetch("http://localhost:8080/notifications/unverified"),
                    fetch("http://localhost:8080/notifications/verified")
                ]);

                // Pastikan respons OK
                if (!unverifiedRes.ok || !verifiedRes.ok) {
                    throw new Error("Failed to fetch notifications");
                }

                // Parse JSON dengan fallback ke array kosong jika data null
                const [unverified, verified] = await Promise.all([
                    unverifiedRes.json().then(data => Array.isArray(data) ? data : []).catch(() => []),
                    verifiedRes.json().then(data => Array.isArray(data) ? data : []).catch(() => [])
                ]);

                console.log("Unverified notifications:", unverified); // Debugging
                console.log("Verified notifications:", verified); // Debugging

                // Tampilkan notifikasi unverified
                if (Array.isArray(unverified)) {
                    unverified.forEach(n => {
                        if (!displayedNotifications.has(n.id)) {
                            displayedNotifications.set(n.id, n);
                            addNotificationToUI(n, false);
                        }
                    });
                } else {
                    console.error("Unverified notifications data is not an array:", unverified);
                }

                // Tampilkan notifikasi verified
                if (Array.isArray(verified)) {
                    verified.forEach(n => {
                        if (!displayedNotifications.has(n.id)) {
                            displayedNotifications.set(n.id, n);
                            addNotificationToUI(n, true);
                        }
                    });
                } else {
                    console.error("Verified notifications data is not an array:", verified);
                }

                // Update dropdown dan badge setelah fetch
                updateNotificationDropdown();
                updateNotificationBadge();
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        // Panggil fetchNotifications saat halaman dimuat
        fetchNotifications();
    </script>
</body>

</html>