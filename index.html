<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #unverified-notifications,
        #verified-notifications {
            margin-top: 20px;
        }

        .notification {
            padding: 10px;
            border: 1px solid #ccc;
            margin: 5px;
        }

        .verified {
            background-color: #d4edda;
        }

        .unverified {
            background-color: #f8d7da;
        }

        button {
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>Live Notifications</h2>
    <button onclick="createNotification()">Create Notification</button>

    <h3>Unverified Notifications</h3>
    <div id="unverified-notifications"></div>

    <h3>Verified Notifications</h3>
    <div id="verified-notifications"></div>

    <script>
        const ws = new WebSocket("ws://localhost:8080/ws");
        const unverifiedDiv = document.getElementById("unverified-notifications");
        const verifiedDiv = document.getElementById("verified-notifications");
        const displayedNotifications = new Map();

        ws.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);
                if (data.payload) {
                    const notification = JSON.parse(data.payload);
                    if (!displayedNotifications.has(notification.id)) {
                        displayedNotifications.set(notification.id, notification);
                        displayNotification(notification, data.channel.includes("verified"));
                    } else if (data.channel.includes("verified")) {
                        moveNotificationToVerified(notification.id);
                    }
                }
            } catch (error) {
                console.error("WebSocket message error:", error);
            }
        };

        async function fetchNotifications(url, isVerified) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Failed to fetch notifications");
                const notifications = await res.json();
                notifications.forEach(n => {
                    if (!displayedNotifications.has(n.id)) {
                        displayedNotifications.set(n.id, n);
                        displayNotification(n, isVerified);
                    }
                });
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        function displayNotification(notification, isVerified) {
            try {
                const div = document.createElement("div");
                div.classList.add("notification", isVerified ? "verified" : "unverified");
                div.innerHTML = `<strong>${isVerified ? "Old Notification" : notification.message}</strong> <small>${new Date(notification.timestamp).toLocaleString()}</small>`;
                div.id = `notif-${notification.id}`;

                if (!isVerified) {
                    const button = document.createElement("button");
                    button.textContent = "Verify";
                    button.onclick = () => verifyNotification(notification.id, div);
                    div.appendChild(button);
                    unverifiedDiv.prepend(div);
                } else {
                    verifiedDiv.prepend(div);
                }
            } catch (error) {
                console.error("Display error:", error);
            }
        }

        function moveNotificationToVerified(id) {
            const element = document.getElementById(`notif-${id}`);
            if (element) {
                element.classList.remove("unverified");
                element.classList.add("verified");
                element.querySelector("button")?.remove();
                element.innerHTML = `<strong>Old Notification</strong> ` + element.innerHTML.split("</strong>")[1];
                verifiedDiv.prepend(element);
            }
        }

        async function verifyNotification(id, element) {
            try {
                const res = await fetch(`http://localhost:8080/notifications/verify/${id}`, { method: "PUT" });
                if (!res.ok) throw new Error("Failed to verify notification");
                moveNotificationToVerified(id);
            } catch (error) {
                console.error("Verification error:", error);
            }
        }

        async function createNotification() {
            try {
                const notification = { message: "New Notification" };
                const res = await fetch("http://localhost:8080/notifications", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(notification)
                });
                if (!res.ok) throw new Error("Failed to create notification");
            } catch (error) {
                console.error("Create notification error:", error);
            }
        }

        fetchNotifications("http://localhost:8080/notifications/unverified", false);
        fetchNotifications("http://localhost:8080/notifications/verified", true);
    </script>
</body>

</html>