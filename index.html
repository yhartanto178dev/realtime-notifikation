<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="p-4">
    <div class="navbar bg-base-100 shadow-lg mb-8">
        <div class="flex-1">
            <a href="#" class="btn btn-ghost normal-case text-xl">NotifyHub</a>
        </div>
        <div class="flex-none">
            <button class="btn btn-ghost">Logout</button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="card bg-base-100 shadow-md mb-6">
            <div class="card-body">
                <h2 class="card-title">Create New Notification</h2>
                <div class="join w-full">
                    <input type="text" id="create-user-id-input" placeholder="Enter User ID"
                        class="input input-bordered join-item w-full">
                    <button onclick="createNotification()" class="btn btn-primary join-item">Create</button>
                </div>
            </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
            <div class="card bg-base-100 shadow-md">
                <div class="card-body">
                    <h3 class="card-title">Unverified Notifications</h3>
                    <div id="unverified-notifications" class="space-y-2"></div>
                </div>
            </div>
            <div class="card bg-base-100 shadow-md">
                <div class="card-body">
                    <h3 class="card-title">Verified Notifications</h3>
                    <div id="verified-notifications" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ws = new WebSocket("ws://localhost:8080/ws");
        const displayedNotifications = new Map(); // Untuk melacak notifikasi yang sudah ditampilkan

        // WebSocket message handler yang diperbarui
        ws.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);
                if (data.payload) {
                    const notification = JSON.parse(data.payload);

                    // Jika notifikasi baru, tambahkan ke UI
                    if (!displayedNotifications.has(notification.id)) {
                        displayedNotifications.set(notification.id, notification);
                        addNotificationToUI(notification, data.channel.includes("verified"));
                    }
                    // Jika notifikasi diverifikasi, pindahkan ke verified
                    else if (data.channel.includes("verified")) {
                        moveNotificationToVerified(notification.id);
                    }
                }
            } catch (error) {
                console.error("WebSocket message error:", error);
            }
        };

        // Fungsi untuk menambahkan notifikasi ke UI
        function addNotificationToUI(notification, isVerified) {
            const container = document.getElementById(isVerified ? "verified-notifications" : "unverified-notifications");

            const div = document.createElement("div");
            div.id = `notif-${notification.id}`;
            div.classList.add("alert", isVerified ? "alert-success" : "alert-error");
            div.innerHTML = `<strong>${notification.message}</strong> <small>${new Date(notification.timestamp).toLocaleString()}</small>`;

            if (!isVerified) {
                const button = document.createElement("button");
                button.textContent = "Verify";
                button.classList.add("btn", "btn-sm");
                button.onclick = () => verifyNotification(notification.id);
                div.appendChild(button);
            }

            container.prepend(div); // Tambahkan di bagian atas
        }

        // Fungsi untuk memindahkan notifikasi ke verified
        function moveNotificationToVerified(id) {
            const element = document.getElementById(`notif-${id}`);
            if (element) {
                // Hapus tombol verify
                const button = element.querySelector('button');
                if (button) button.remove();

                // Update styling
                element.classList.remove('alert-error');
                element.classList.add('alert-success');

                // Pindahkan ke container verified
                document.getElementById('verified-notifications').prepend(element);
            }
        }

        // Fungsi createNotification yang diperbarui
        async function createNotification() {
            const userID = document.getElementById("create-user-id-input").value;
            if (!userID) return alert("Please enter a User ID");
            try {
                const res = await fetch("http://localhost:8080/notifications", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "New Notification", user_id: userID })
                });
                if (!res.ok) throw new Error("Failed to create notification");

                // Kosongkan input setelah berhasil
                document.getElementById("create-user-id-input").value = "";
            } catch (error) {
                console.error("Create notification error:", error);
            }
        }

        // Fungsi verifikasi yang diperbarui
        async function verifyNotification(id) {
            try {
                const res = await fetch(`http://localhost:8080/notifications/verify/${id}`, { method: "PUT" });
                if (!res.ok) throw new Error("Failed to verify notification");

                // Pindahkan notifikasi secara lokal
                moveNotificationToVerified(id);
            } catch (error) {
                console.error("Verification error:", error);
            }
        }

        // Fungsi fetch yang diperbarui
        async function fetchNotifications() {
            try {
                const [unverifiedRes, verifiedRes] = await Promise.all([
                    fetch("http://localhost:8080/notifications/unverified"),
                    fetch("http://localhost:8080/notifications/verified")
                ]);

                // Pastikan respons OK dan data valid
                if (!unverifiedRes.ok || !verifiedRes.ok) {
                    throw new Error("Failed to fetch notifications");
                }

                const [unverified, verified] = await Promise.all([
                    unverifiedRes.json(),
                    verifiedRes.json()
                ]);

                // Pastikan data adalah array sebelum menggunakan forEach
                if (Array.isArray(unverified)) {
                    unverified.forEach(n => {
                        if (!displayedNotifications.has(n.id)) {
                            displayedNotifications.set(n.id, n);
                            addNotificationToUI(n, false);
                        }
                    });
                } else {
                    console.error("Unverified notifications data is not an array:", unverified);
                }

                if (Array.isArray(verified)) {
                    verified.forEach(n => {
                        if (!displayedNotifications.has(n.id)) {
                            displayedNotifications.set(n.id, n);
                            addNotificationToUI(n, true);
                        }
                    });
                } else {
                    console.error("Verified notifications data is not an array:", verified);
                }
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        // Panggil fetchNotifications saat halaman dimuat
        fetchNotifications();
    </script>
</body>

</html>